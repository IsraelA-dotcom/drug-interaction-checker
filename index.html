<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Interaction Checker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 30px;
        }

        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }

        .content { padding: 30px; }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .add-btn {
            padding: 14px 28px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .add-btn:hover { background: #1d4ed8; }
        .add-btn:disabled { background: #d1d5db; cursor: not-allowed; }

        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        .error, .success {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .med-section {
            margin-bottom: 20px;
        }

        .med-section h3 {
            font-size: 14px;
            color: #374151;
            margin-bottom: 10px;
        }

        .med-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .med-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #1e40af;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
        }

        .alert-box {
            background: linear-gradient(135deg, #fef2f2 0%, #fef9c3 100%);
            border-left: 4px solid #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-box h3 {
            color: #111827;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .alert-box p {
            color: #374151;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .severity-counts {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .network-container {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 12px;
            padding: 20px;
            height: 500px;
            margin-bottom: 20px;
            position: relative;
        }

        .empty-state {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #9ca3af;
        }

        #network {
            width: 100%;
            height: 100%;
        }

        .details-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .details-box h3 {
            font-size: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
        }

        .details-content { font-size: 14px; }
        .details-row { margin-bottom: 12px; }
        .details-label { font-weight: 600; color: #374151; }

        .severity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .legend {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .legend h3 { font-size: 14px; margin-bottom: 12px; }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .legend-line {
            width: 40px;
            height: 3px;
            border-radius: 2px;
        }

        .legend-text strong {
            display: block;
            color: #111827;
            margin-bottom: 2px;
        }

        .legend-text small { color: #6b7280; }

        .disclaimer {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            font-size: 12px;
            color: #78350f;
            line-height: 1.6;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Drug Interaction Checker</h1>
            <p>Check medication safety instantly</p>
        </div>

        <div class="content">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Enter medication name..."
                >
                <button id="addBtn" class="add-btn">Add</button>
            </div>
            <p class="hint">Try: aspirin, paracetamol, ibuprofen, warfarin</p>
            <div id="message"></div>

            <div id="medSection" class="med-section" style="display: none;">
                <h3>Your Medications (<span id="medCount">0</span>)</h3>
                <div id="medList" class="med-list"></div>
            </div>

            <div id="alertBox" style="display: none;"></div>

            <div class="network-container">
                <div id="emptyState" class="empty-state">
                    <p style="font-weight: 500; margin-bottom: 4px;">No medications added</p>
                    <p style="font-size: 14px;">Add medications above to check for interactions</p>
                </div>
                <svg id="network" style="display: none;"></svg>
            </div>

            <div id="detailsBox" style="display: none;"></div>

            <div class="legend">
                <h3>Severity Guide</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #dc2626;"></div>
                        <div class="legend-text">
                            <strong>High</strong>
                            <small>Avoid combination - consult doctor</small>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #f59e0b;"></div>
                        <div class="legend-text">
                            <strong>Moderate</strong>
                            <small>Use with caution - monitoring needed</small>
                        </div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #10b981;"></div>
                        <div class="legend-text">
                            <strong>Low</strong>
                            <small>Minor interaction - manageable</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="disclaimer">
                <strong>Important:</strong> This tool uses official drug databases but is not a substitute for professional medical advice. 
                Always consult your doctor or pharmacist about medication interactions.
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        let meds = [];
        let links = [];

        const input = document.getElementById('searchInput');
        const btn = document.getElementById('addBtn');
        const msg = document.getElementById('message');
        const medSec = document.getElementById('medSection');
        const medList = document.getElementById('medList');
        const medCount = document.getElementById('medCount');
        const alertBox = document.getElementById('alertBox');
        const empty = document.getElementById('emptyState');
        const svg = document.getElementById('network');
        const details = document.getElementById('detailsBox');

        function showMsg(text, type) {
            msg.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 5000);
        }

        async function searchDrug(term) {
            try {
                const res = await fetch(`${API}/api/search?q=${encodeURIComponent(term)}`);
                if (!res.ok) return null;
                const data = await res.json();
                if (data.name && data.name.length > 50) {
                    data.name = term.charAt(0).toUpperCase() + term.slice(1);
                }
                return data;
            } catch (err) {
                console.error(err);
                return null;
            }
        }

        async function getInteractions() {
            if (meds.length < 2) {
                links = [];
                return;
            }

            try {
                const res = await fetch(`${API}/api/interactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drugs: meds })
                });

                if (res.ok) {
                    links = await res.json();
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function addDrug() {
            const term = input.value.trim();
            if (!term) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>';

            const drug = await searchDrug(term);

            if (drug) {
                if (meds.some(m => m.rxcui === drug.rxcui)) {
                    showMsg('Already in your list', 'error');
                } else {
                    meds.push({
                        rxcui: drug.rxcui,
                        name: drug.name,
                        x: 300 + Math.random() * 200,
                        y: 250 + Math.random() * 100,
                        vx: 0,
                        vy: 0
                    });
                    input.value = '';
                    await getInteractions();
                    render();
                    showMsg(`Added ${drug.name}`, 'success');
                }
            } else {
                showMsg('Drug not found. Try generic name', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Add';
        }

        function removeDrug(rxcui) {
            meds = meds.filter(m => m.rxcui !== rxcui);
            getInteractions().then(render);
        }

        function getSeverityColor(s) {
            const severity = s?.toLowerCase();
            if (severity === 'high' || severity === 'severe') return '#dc2626';
            if (severity === 'moderate') return '#f59e0b';
            return '#10b981';
        }

        function render() {
            medCount.textContent = meds.length;
            
            if (meds.length === 0) {
                medSec.style.display = 'none';
                alertBox.style.display = 'none';
                empty.style.display = 'flex';
                svg.style.display = 'none';
                details.style.display = 'none';
                return;
            }

            medSec.style.display = 'block';
            empty.style.display = 'none';
            svg.style.display = 'block';

            medList.innerHTML = meds.map(m => `
                <div class="med-tag">
                    <span>${m.name}</span>
                    <button class="remove-btn" onclick="removeDrug('${m.rxcui}')">×</button>
                </div>
            `).join('');

            if (links.length > 0) {
                const high = links.filter(l => l.severity === 'high').length;
                const mod = links.filter(l => l.severity === 'moderate').length;
                const low = links.filter(l => l.severity === 'low').length;

                alertBox.style.display = 'block';
                alertBox.innerHTML = `
                    <div class="alert-box">
                        <h3>⚠️ ${links.length} Interaction${links.length > 1 ? 's' : ''} Found</h3>
                        <p>Review the connections in the network below</p>
                        <div class="severity-counts">
                            ${high > 0 ? `<span style="color: #dc2626; font-weight: 600;">${high} High Risk</span>` : ''}
                            ${mod > 0 ? `<span style="color: #f59e0b; font-weight: 600;">${mod} Moderate</span>` : ''}
                            ${low > 0 ? `<span style="color: #10b981; font-weight: 600;">${low} Low</span>` : ''}
                        </div>
                    </div>
                `;
            } else {
                alertBox.style.display = 'none';
            }

            draw();
        }

        function draw() {
            const rect = svg.parentElement.getBoundingClientRect();
            const w = rect.width - 40;
            const h = rect.height - 40;

            svg.setAttribute('width', w);
            svg.setAttribute('height', h);
            svg.innerHTML = '';

            links.forEach(link => {
                const s = meds.find(m => m.rxcui === link.source);
                const t = meds.find(m => m.rxcui === link.target);
                if (!s || !t) return;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', s.x);
                line.setAttribute('y1', s.y);
                line.setAttribute('x2', t.x);
                line.setAttribute('y2', t.y);
                line.setAttribute('stroke', getSeverityColor(link.severity));
                line.setAttribute('stroke-width', '3');
                line.setAttribute('opacity', '0.7');
                line.style.cursor = 'pointer';
                line.onclick = () => showDetails(link);
                svg.appendChild(line);
            });

            meds.forEach(m => {
                const hasLink = links.some(l => l.source === m.rxcui || l.target === m.rxcui);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', m.x);
                circle.setAttribute('cy', m.y);
                circle.setAttribute('r', '38');
                circle.setAttribute('fill', 'white');
                circle.setAttribute('stroke', hasLink ? '#dc2626' : '#2563eb');
                circle.setAttribute('stroke-width', '3');
                circle.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))';
                svg.appendChild(circle);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', m.x);
                text.setAttribute('y', m.y);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', '#1e40af');
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', '600');
                text.textContent = m.name.length > 12 ? m.name.substring(0, 11) + '...' : m.name;
                svg.appendChild(text);
            });
        }

        function showDetails(link) {
            const s = meds.find(m => m.rxcui === link.source);
            const t = meds.find(m => m.rxcui === link.target);
            const color = getSeverityColor(link.severity);

            details.style.display = 'block';
            details.innerHTML = `
                <div class="details-box">
                    <h3>
                        Interaction Details
                        <button class="remove-btn" onclick="document.getElementById('detailsBox').style.display='none'">×</button>
                    </h3>
                    <div class="details-content">
                        <div class="details-row">
                            <span class="details-label">Between: </span>
                            ${s.name} and ${t.name}
                        </div>
                        <div class="details-row">
                            <span class="details-label">Severity: </span>
                            <span class="severity-badge" style="background: ${color}20; color: ${color};">
                                ${link.severity}
                            </span>
                        </div>
                        <div class="details-row">
                            <span class="details-label" style="display: block; margin-bottom: 8px;">Details:</span>
                            <p style="line-height: 1.6; color: #111827;">${link.description}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function simulate() {
            if (meds.length === 0) return;

            const w = svg.clientWidth;
            const h = svg.clientHeight;
            const cx = w / 2;
            const cy = h / 2;

            meds.forEach(m => {
                m.vx = (m.vx || 0) * 0.85;
                m.vy = (m.vy || 0) * 0.85;
                m.vx += (cx - m.x) * 0.02;
                m.vy += (cy - m.y) * 0.02;
            });

            for (let i = 0; i < meds.length; i++) {
                for (let j = i + 1; j < meds.length; j++) {
                    const dx = meds[j].x - meds[i].x;
                    const dy = meds[j].y - meds[i].y;
                    const d = Math.sqrt(dx * dx + dy * dy);

                    if (d < 120 && d > 0) {
                        const f = (120 - d) / d * 0.8;
                    meds[i].vx -= dx * f;
                        meds[i].vy -= dy * f;
                        meds[j].vx += dx * f;
                        meds[j].vy += dy * f;
                    }
                }
            }

            links.forEach(link => {
                const s = meds.find(n => n.rxcui === link.source);
                const t = meds.find(n => n.rxcui === link.target);
                if (s && t) {
                    const dx = t.x - s.x;
                    const dy = t.y - s.y;
                    const d = Math.sqrt(dx * dx + dy * dy);
                    const target = 180;

                    if (d > 0) {
                        const f = (d - target) / d * 0.15;
                        s.vx += dx * f;
                        s.vy += dy * f;
                        t.vx -= dx * f;
                        t.vy -= dy * f;
                    }
                }
            });

            meds.forEach(m => {
                m.x += m.vx || 0;
                m.y += m.vy || 0;

                const margin = 50;
                m.x = Math.max(margin, Math.min(w - margin, m.x));
                m.y = Math.max(margin, Math.min(h - margin, m.y));
            });

            draw();
        }

        btn.onclick = addDrug;
        input.onkeypress = (e) => {
            if (e.key === 'Enter') addDrug();
        };

        setInterval(simulate, 30);
    </script>
</body>
</html>
